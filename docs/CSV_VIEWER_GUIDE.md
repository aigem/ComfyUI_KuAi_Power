# CSV 查看器使用指南

## 概述

ComfyUI_KuAi_Power 现在提供了两个增强的 CSV 处理节点：

1. **CSVBatchReader** - CSV 批量读取器（已升级支持文件上传）
2. **CSVViewer** - CSV 查看器（全新节点，支持表格可视化）

## 新功能特性

### 1. 文件上传功能

两个节点现在都支持直接从本地上传 CSV 文件，就像上传图片一样简单！

**使用方法**:
1. 在节点中找到 "上传文件" 参数
2. 点击上传按钮
3. 从本地选择 CSV 文件
4. 文件会自动上传到 ComfyUI 的 `input/` 目录
5. 刷新节点或重新加载页面后，文件会出现在下拉菜单中

### 2. CSV 表格查看器

**CSVViewer** 节点提供了强大的表格可视化功能：

- ✅ 以表格形式显示 CSV 内容
- ✅ 自动格式化和美化
- ✅ 支持大文件（可限制显示行数）
- ✅ 固定表头，方便滚动查看
- ✅ 斑马纹行，提高可读性
- ✅ 响应式设计，自动调整大小

## 节点详细说明

### CSVBatchReader（CSV 批量读取器）

**功能**: 读取 CSV 文件并解析为批量任务数据

**输入参数**:
- **CSV文件** (必需): 从下拉菜单选择已上传的 CSV 文件
- **上传文件** (可选): 点击上传新的 CSV 文件
- **文件路径** (可选): 或者直接输入 CSV 文件的完整路径

**输出**:
- **批量任务数据**: JSON 格式的任务列表，可传递给 NanoBananaBatchProcessor

**使用场景**:
- 批量图像生成
- 批量图像编辑
- 自动化工作流

**示例工作流**:
```
CSVBatchReader
  → NanoBananaBatchProcessor
  → 批量生成图像
```

### CSVViewer（CSV 查看器）

**功能**: 以表格形式查看 CSV 文件内容

**输入参数**:
- **CSV文件** (必需): 从下拉菜单选择已上传的 CSV 文件
- **上传文件** (可选): 点击上传新的 CSV 文件
- **文件路径** (可选): 或者直接输入 CSV 文件的完整路径
- **最大行数** (可选): 限制显示的行数（默认 100 行，最大 10000 行）

**输出**:
- **表格数据**: JSON 格式的表格数据
- **可视化表格**: 直接在节点中显示格式化的表格

**使用场景**:
- 检查 CSV 文件内容
- 验证批量任务数据
- 调试工作流
- 数据预览

**表格特性**:
- 固定表头（滚动时表头保持可见）
- 斑马纹行（偶数行深色背景）
- 悬停高亮（鼠标悬停时行高亮）
- 自定义滚动条（美化的滚动条样式）
- 响应式布局（自动适应节点大小）

## 使用方法

### 方法 1: 文件上传（推荐）

1. **添加节点**:
   - 在 ComfyUI 中添加 `CSVBatchReader` 或 `CSVViewer` 节点

2. **上传文件**:
   - 找到节点中的 "上传文件" 参数
   - 点击上传按钮
   - 选择本地的 CSV 文件
   - 等待上传完成

3. **选择文件**:
   - 刷新节点（右键 → Refresh）或重新加载页面
   - 从 "CSV文件" 下拉菜单中选择刚上传的文件

4. **执行节点**:
   - 点击 "Queue Prompt" 执行工作流
   - CSVViewer 会在节点中显示表格

### 方法 2: 手动复制文件

1. **复制文件到 input 目录**:
   ```bash
   # 将 CSV 文件复制到 ComfyUI 的 input 目录
   cp your_file.csv /path/to/ComfyUI/input/
   ```

2. **刷新节点**:
   - 在 ComfyUI 中刷新节点
   - 文件会出现在下拉菜单中

3. **选择并执行**:
   - 从下拉菜单选择文件
   - 执行工作流

### 方法 3: 直接输入路径

1. **输入完整路径**:
   - 在 "文件路径" 参数中输入 CSV 文件的完整路径
   - 例如: `/home/user/data/tasks.csv`

2. **执行节点**:
   - 直接执行工作流
   - 节点会从指定路径读取文件

## CSV 文件格式要求

### 编码格式
- 支持 UTF-8 和 UTF-8 BOM 编码
- 推荐使用 UTF-8 编码

### 文件结构
- 第一行必须是标题行（列名）
- 数据从第二行开始
- 支持空行（会自动跳过）

### 示例 CSV 文件

**批量图像生成任务**:
```csv
task_type,prompt,model_name,seed,aspect_ratio
generate,A futuristic city at sunset,gemini-3-pro-image-preview,42,16:9
generate,A cute cat playing with yarn,gemini-2.5-flash-image,0,1:1
generate,Mountain landscape with lake,gemini-3-pro-image-preview,123,9:16
```

**批量图像编辑任务**:
```csv
task_type,prompt,image_1,seed,temperature
edit,Make the sky more dramatic,/path/to/image1.jpg,42,1.0
edit,Add more vibrant colors,/path/to/image2.jpg,0,0.8
edit,Enhance the lighting,/path/to/image3.jpg,123,1.2
```

## 表格显示样式

CSVViewer 提供了专业的表格显示样式：

### 颜色方案
- **背景色**: 深色主题（#1e1e1e）
- **表头**: 深灰色（#333），白色文字
- **数据行**: 交替深浅灰色（#252525 / #2a2a2a）
- **悬停效果**: 浅灰色高亮（#3a3a3a）

### 布局特性
- **固定表头**: 滚动时表头始终可见
- **自动滚动**: 内容超出时显示滚动条
- **响应式**: 自动适应节点大小
- **最大高度**: 500px（可滚动查看更多内容）

### 文本格式
- **表头**: 粗体，12px
- **数据**: 常规，12px
- **文件信息**: 14px，显示文件名和行数

## 常见问题

### Q1: 上传文件后在下拉菜单中看不到？

**解决方法**:
1. 右键点击节点 → 选择 "Refresh"
2. 或者重新加载 ComfyUI 页面（F5）
3. 检查文件是否成功上传到 `ComfyUI/input/` 目录

### Q2: 表格显示不完整？

**解决方法**:
1. 调整节点大小（拖动节点边缘）
2. 使用滚动条查看更多内容
3. 增加 "最大行数" 参数（CSVViewer）

### Q3: 文件上传失败？

**可能原因**:
1. 文件格式不是 CSV
2. 文件编码不支持（请使用 UTF-8）
3. 文件过大（建议小于 10MB）
4. 权限问题（检查 input 目录权限）

**解决方法**:
- 使用 "文件路径" 参数直接输入路径
- 手动复制文件到 input 目录
- 检查文件编码和格式

### Q4: 表格样式显示异常？

**解决方法**:
1. 清除浏览器缓存
2. 重新加载 ComfyUI 页面
3. 检查浏览器控制台是否有错误信息

### Q5: 如何查看大型 CSV 文件？

**建议**:
1. 使用 CSVViewer 的 "最大行数" 参数限制显示
2. 分批处理大文件
3. 使用外部工具预处理数据

## 技术细节

### 文件上传机制

两个节点都使用 ComfyUI 的标准文件上传机制：

```python
"upload": ("IMAGEUPLOAD", {"tooltip": "点击上传 CSV 文件"})
```

虽然类型名为 `IMAGEUPLOAD`，但它实际上是一个通用的文件上传 widget，可以上传任何类型的文件。

### 表格渲染

CSVViewer 使用自定义的前端扩展（`web/csv_viewer.js`）来渲染表格：

1. **后端**: 读取 CSV 文件，解析为 JSON 数据
2. **前端**: 接收 JSON 数据，生成 HTML 表格
3. **样式**: 应用 CSS 样式，实现美化效果
4. **交互**: 支持滚动、悬停等交互效果

### 数据流

```
CSV 文件
  ↓
CSVBatchReader (读取并解析)
  ↓
JSON 数据
  ↓
NanoBananaBatchProcessor (批量处理)
  ↓
生成的图像
```

或者：

```
CSV 文件
  ↓
CSVViewer (读取并可视化)
  ↓
表格显示 + JSON 数据
```

## 最佳实践

### 1. 文件命名
- 使用有意义的文件名（如 `product_images_batch.csv`）
- 避免使用特殊字符和空格
- 使用小写字母和下划线

### 2. 数据组织
- 第一行必须是列名
- 列名使用英文（避免中文）
- 数据格式保持一致

### 3. 文件管理
- 定期清理 input 目录中的旧文件
- 使用子目录组织不同类型的文件
- 备份重要的 CSV 文件

### 4. 性能优化
- 大文件分批处理
- 使用 "最大行数" 限制显示
- 避免在 CSV 中存储大量文本

### 5. 调试技巧
- 使用 CSVViewer 预览数据
- 检查列名是否正确
- 验证数据格式是否符合要求

## 相关文档

- [CSV 批量处理指南](./NANOBANA_BATCH_GUIDE.md)
- [CSV 模板说明](./workflows/CSV_TEMPLATES_README.md)
- [CSV 快速参考](./workflows/CSV_QUICK_REFERENCE.md)
- [项目文档](./CLAUDE.md)

## 更新日志

### 2025-12-13
- ✅ CSVBatchReader 添加文件上传功能
- ✅ 新增 CSVViewer 节点
- ✅ 实现表格可视化功能
- ✅ 添加前端扩展支持
- ✅ 创建使用指南文档

---

**提示**: 如果遇到问题，请查看 ComfyUI 控制台输出的日志信息，通常会有详细的错误提示。
